name: End-to-end tests
on: [push]
jobs:
  automated_tests:
    runs-on: ubuntu-20.04
    container: node:16.15.0
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_DB: 'test_farm'
          POSTGRES_USER: 'postgres'
          POSTGRES_PASSWORD: 'pipeline'
          POSTGRES_HOST: postgres
          POSTGRES_PORT: 5432
        ports:
          - "5432:5432"
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    env:
      JWT_INVITE_SECRET: ${{secrets.JWT_INVITE_SECRET}}
      JWT_RESET_SECRET: ${{secrets.JWT_RESET_SECRET}}
      JWT_SCHEDULER_SECRET: ${{secrets.JWT_SCHEDULER_SECRET}}
      JWT_SECRET: ${{secrets.JWT_SECRET}}
      TEST_USER: ${{secrets.TEST_USER}}
      TEST_USER_ID: ${{secrets.TEST_USER_ID}}
    steps:
      # Checkout the current code in the repository
      - name: Check out repository code
        uses: actions/checkout@v3
      # Install all the dependencies
      - name: Install dependencies
        run: cd packages/api && npm ci && cd ../shared && npm ci
      # Run migrations on the database
      - name: Setup database
        run: cd packages/api && npm run migrate:pipeline:db
      - name: Public IP
        id: ip
        uses: haythem/public-ip@v1.2
      - name: START
        run: cd packages/api && npm run start
    outputs:
          ipAddress: ${{ steps.ip.outputs.ipv4 }}
        

        
  
  basic-pnpm-ubuntu-20:
      runs-on: ubuntu-latest
      container: cypress/browsers:node12.18.3-chrome87-ff82
      env: 
          VITE_API_URL: "${{ needs.spin_up.outputs.ipAddress }}/5001"
          
      steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      - name: Install dependencies
        run: |
          echo ${{ VITE_API_URL }}
            npm install -g n
            n lts
            cd packages/webapp && pnpm install --no-frozen-lockfile

      - name: Cypress run
        uses: cypress-io/github-action@v4.2.0
        with:
          install: false
          wait-on: 'http://localhost:3000'
          working-directory: packages/webapp
          wait-on-timeout: 120
          browser: chrome
          build: npx cypress info
          start: pnpm dev
